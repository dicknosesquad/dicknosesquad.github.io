# Core ERP System with AI Integration
from datetime import datetime
import sqlite3
from typing import Dict, List
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
import numpy as np

class AIEnhancedERP:
    def __init__(self):
        self.conn = sqlite3.connect('erp_database.db')
        self.setup_database()
        self.ml_models = {}

    def setup_database(self):
        cursor = self.conn.cursor()
        
        # Create core ERP tables
        cursor.executescript("""
            CREATE TABLE IF NOT EXISTS inventory (
                item_id TEXT PRIMARY KEY,
                name TEXT,
                quantity INTEGER,
                reorder_point INTEGER,
                unit_cost REAL,
                last_updated TIMESTAMP
            );

            CREATE TABLE IF NOT EXISTS sales (
                sale_id TEXT PRIMARY KEY,
                customer_id TEXT,
                total_amount REAL,
                timestamp TIMESTAMP,
                status TEXT
            );

            CREATE TABLE IF NOT EXISTS forecasts (
                forecast_id TEXT PRIMARY KEY,
                item_id TEXT,
                predicted_demand REAL,
                confidence_score REAL,
                forecast_date TIMESTAMP,
                FOREIGN KEY (item_id) REFERENCES inventory(item_id)
            );

            CREATE TABLE IF NOT EXISTS finance (
                transaction_id TEXT PRIMARY KEY,
                amount REAL,
                type TEXT,
                category TEXT,
                timestamp TIMESTAMP
            );
        """)
        self.conn.commit()

    def add_inventory_item(self, item_data: Dict):
        cursor = self.conn.cursor()
        cursor.execute("""
            INSERT INTO inventory (item_id, name, quantity, reorder_point, unit_cost, last_updated)
            VALUES (?, ?, ?, ?, ?, ?)
        """, (
            item_data['item_id'],
            item_data['name'],
            item_data['quantity'],
            item_data['reorder_point'],
            item_data['unit_cost'],
            datetime.now()
        ))
        self.conn.commit()

    def predict_demand(self, item_id: str, historical_data: List[Dict]) -> Dict:
        """
        AI-powered demand forecasting
        """
        if item_id not in self.ml_models:
            self.ml_models[item_id] = RandomForestRegressor(n_estimators=100)

        # Prepare historical data
        df = pd.DataFrame(historical_data)
        features = ['season', 'price', 'marketing_spend']
        X = df[features]
        y = df['demand']

        # Train model
        self.ml_models[item_id].fit(X, y)

        # Make prediction
        latest_data = X.iloc[-1].values.reshape(1, -1)
        predicted_demand = self.ml_models[item_id].predict(latest_data)[0]
        confidence = self.ml_models[item_id].score(X, y)

        return {
            'item_id': item_id,
            'predicted_demand': predicted_demand,
            'confidence_score': confidence,
            'forecast_date': datetime.now()
        }

    def optimize_inventory(self) -> List[Dict]:
        """
        AI-powered inventory optimization
        """
        cursor = self.conn.cursor()
        cursor.execute("SELECT * FROM inventory")
        inventory_items = cursor.fetchall()
        
        optimized_orders = []
        for item in inventory_items:
            # Get historical demand data
            cursor.execute("""
                SELECT * FROM sales 
                WHERE item_id = ? 
                ORDER BY timestamp DESC 
                LIMIT 90
            """, (item[0],))
            sales_history = cursor.fetchall()
            
            if len(sales_history) > 0:
                # Calculate optimal reorder point using ML
                demand_forecast = self.predict_demand(item[0], sales_history)
                lead_time = 7  # days
                safety_stock = np.std([s[3] for s in sales_history]) * 1.96  # 95% confidence
                
                optimal_reorder_point = (demand_forecast['predicted_demand'] * lead_time) + safety_stock
                
                if item[2] < optimal_reorder_point:  # current quantity < reorder point
                    optimized_orders.append({
                        'item_id': item[0],
                        'name': item[1],
                        'current_quantity': item[2],
                        'suggested_order': int(optimal_reorder_point - item[2]),
                        'confidence': demand_forecast['confidence_score']
                    })
        
        return optimized_orders

    def generate_financial_report(self) -> Dict:
        """
        Generate comprehensive financial analysis
        """
        cursor = self.conn.cursor()
        
        # Get revenue
        cursor.execute("""
            SELECT SUM(total_amount) 
            FROM sales 
            WHERE timestamp >= date('now', '-30 days')
        """)
        revenue = cursor.fetchone()[0] or 0
        
        # Get expenses
        cursor.execute("""
            SELECT SUM(amount) 
            FROM finance 
            WHERE type = 'expense' 
            AND timestamp >= date('now', '-30 days')
        """)
        expenses = cursor.fetchone()[0] or 0
        
        # Calculate metrics
        gross_profit = revenue - expenses
        profit_margin = (gross_profit / revenue * 100) if revenue > 0 else 0
        
        return {
            'revenue': revenue,
            'expenses': expenses,
            'gross_profit': gross_profit,
            'profit_margin': profit_margin,
            'generated_at': datetime.now()
        }

    def close(self):
        self.conn.close()
